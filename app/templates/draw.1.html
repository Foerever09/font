<html>
   <title>Handwriting Monkey</title>
   <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
        <style>
            body {width: 100%;
                  position: fixed; 
                  height: 100%; 
                  overflow: hidden;
                  touch-action: none
            }
            
        </style>
        </head>
   <body>
        <script src="/static/js/FileSaver.js"></script>
        <form action="" method="post">
            Text<input id="text" type="text" name="text" value="">
            <button name="save-text" onclick="downloadText()"><a id="textlink"download="inpText.txt">Save text</a></button>
            <br>
            <p>{{ result }}</p>
            <svg id="svg1" baseProfile="full" height="200" width="100%" version="1.1" 
                style="border: 1px solid black;"
                xmlns="http://www.w3.org/2000/svg" 
                xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xlink="http://www.w3.org/1999/xlink"
                onmousedown="mouseDown(evt)" onmouseup="mouseUp(evt)" onmousemove="mouseMove(evt)"
                ontouchstart="mouseDown(evt)" ontouchmove="mouseMove(evt)" ontouchend="mouseUp(evt)" 
                onpointerdown="detectInputType(event)">
                <script type="text/JavaScript">
                    <![CDATA[
                        var svg = document.getElementById("svg1");
                        var pt = svg.createSVGPoint();
                        isDrawing = false;

                        function detectInputType(event) {
                            switch(event.pointerType) {
                                case "mouse":
                                    document.getElementById("text").value = event.pointerType;
                                    break;
                                case "pen":
                                   document.getElementById("text").value = event.pointerType;
                                    break;
                                case "touch":
                                    document.getElementById("text").value = event.pointerType;
                                    break;
                                default:
                                    /* pointerType is empty (could not be detected)
                                    or UA-specific custom type */
                                    document.getElementById("text").value = event.pointerType;
                            }
                        }

                        function alert_coords(evt) {
                            
                            if(evt.targetTouches) {
                                // Prefer Touch Events
                               
                                pt.x = evt.targetTouches[0].clientX;
                                pt.y = evt.targetTouches[0].clientY;
                            } else {
                                pt.x = evt.clientX;
                                pt.y = evt.clientY;
                            }
                            // The cursor point, translated into svg coordinates
                            var point =  pt.matrixTransform(svg.getScreenCTM().inverse());
                            return point;
                        }
                        function mouseDown(evt) {
                            
                            point = alert_coords(evt);
                            isDrawing = true;
                            var path = document.getElementById("path1");
                            var d = path.getAttributeNS(null, "d") + "M"+ point.x + "," + point.y+ " ";
                            path.setAttributeNS(null, "d", d);
                        }
                        function mouseUp(evt) {
                            
                            if (isDrawing === true) {
                                point = alert_coords(evt);
                                var path = document.getElementById("path1");
                                var d = path.getAttributeNS(null, "d") + "M"+ point.x + "," + point.y+ " ";
                                path.setAttributeNS(null, "d", d);
                                isDrawing = false;
                            }
                        }
                        function mouseMove(evt) {
                            
                            if (isDrawing === true) {
                                point = alert_coords(evt);
                                var path = document.getElementById("path1");
                                x = point.x;
                                y = point.y ;
                                var d = path.getAttributeNS(null, "d") + "L"+ x + "," + y + " ";
                                path.setAttributeNS(null, "d", d);
                            }
                        }
                    ]]>
                </script>
                <path id="path1" d="" fill="none" stroke="blue" stroke-width="1" /> 
            </svg>
            <br>
            <button type="submit" name="save-writing" onclick="downloadSvg()"><a id="link"download="writing.svg">Save style</a></button>
        </form>
      <img src="{{url}}"/>
      <script type="text/javascript">
            function downloadText(){
                // var blob = new Blob([document.getElementById('text').value],
                //     {type: "text/plain;charset=utf-8"});
                // saveAs(blob, "inpText.txt");
                var source = document.getElementById('text').value;
                var url = "data:text/plain;charset=UTF-8," + encodeURIComponent(source);
                //set url value to a element's href attribute.
                document.getElementById("textlink").href = url;
                
            }
            function downloadSvg() {
                //get svg element.
                var svg = document.getElementById("svg1");
                //get svg source.
                var serializer = new XMLSerializer();
                var source = serializer.serializeToString(svg);
                //add xml declaration
                source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
                //convert svg source to URI data scheme.
                var url = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source);
                //set url value to a element's href attribute.
                document.getElementById("link").href = url;
                //you can download svg file by right click menu.
            }
      </script>
   </body>
</html>
